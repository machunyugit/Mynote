## Mongodb(版本 3.6)

### 概要

1. 索引通常能够极大的提高查询的效率，如果没有索引，MongoDB在读取数据时必须扫描集合中的每个文件并选取那些符合查询条件的记录。
2. 这种扫描全集合的查询效率是非常低的，特别在处理大量的数据时，查询可以要花费几十秒甚至几分钟，这对网站的性能是非常致命的。
3. 索引是特殊的数据结构，索引存储在一个易于遍历读取的数据集合中，索引是对数据库表中一列或多列的值进行排序的一种结构

### 创建索引

1. 测试没加索引的性能

   ```javascript
   //准备数据
       for (var i = 0; i < 20000;i++) {
           db.books.insert({number:i,name:i+"book"});
       }
   //计算查询需要的时间
       var start = new Date();
       db.books.find({number:165871});
       var end = new Date();
       end - start   //150
   
   for(i=0;i<100000;i++){
       db.users.insert({
           "_id":i,
           "username":"user"+i, 
           "age":Math.floor(Math.random()*120), 
       	"created":new Date()});
   }
   ```

2. MongoDB使用 createIndex() 方法来创建索引。

   > 注意在 3.0.0 版本前创建索引方法为 db.collection.ensureIndex()，之后的版本使用了 db.collection.createIndex() 方法，ensureIndex() 还能用，但只是 createIndex() 的别名。

   * 语法

     createIndex()方法基本语法格式如下所示：

     ```javascript
     >db.collection.createIndex(keys, options)
     ```

     __语法中 Key 值为你要创建的索引字段，1 为指定按升序创建索引，如果你想按降序来创建索引指定为 -1 即可。__ 

   * 实例

     ```javascript
     >db.col.createIndex({"title":1})
     ```

   * createIndex() 方法中你也可以设置使用多个字段创建索引（关系型数据库中称作复合索引）。

     ```javascript
     db.collection.createIndex({"title":1,"description":-1},{name:"title_desc"})
     ```

3. 索引的使用需要注意的地方

   * 创建索引的时候注意 1 是正序创建索引 -1 是倒序创建索引

   * 索引的创建在提高查询性能的同时会影响插入的性能

     对于经常查询少插入的文档可以考虑用索引

   * 复合索引要注意索引的先后顺序

   * 在做排序查询的时候也可以加上索引

### 选择键的方向

1. 只有基于多个查询条件进行排序时，索引方向才是比较重要的。如果只是基于单一键进行排序，MongoDB可以简单地从相反方向读取索引。

### 使用覆盖索引

为了确保查询只是用索引就可以完成，应该使用投射来制定不要返回 “_id” 字段 ( 除非它是索引的一部分)。可能需要对不需要查询的字段做索引。

### 索引的名称

```javascript
db.collection.createIndex({"title":1,"description":-1},{name:"title_desc"})
```

### 创建唯一索引

```javascript
db.collection.createIndex({"number":1},{"unique":true});
```

### 强制指定 使用那个索引

```javascript
db.books.find({"name":"0book"}).hint(name:-1);
```

### 稀疏索引(Sparse Index)

- 稀疏索引仅包含具有索引字段的文档的条目，即使索引字段包含空值也是如此。索引会跳过缺少索引字段的任何文档。索引是“稀疏的”，因为它不包含集合的所有文档。 

  ```javascript
  //值1指定按升序对项目进行排序的索引。值-1表示按降序对项目进行排序的索引
  db.users.createIndex({"_id":-1},{name:"idIndex"})  //_id 倒序索引
  db.users.createIndex({"_id":1})   //_id 正序索引
  
  
  db.collection.createIndex({"_id":1},{sparse:true});
  ```

  

### OR查询

`$or` 查询可以对每个子句都使用索引, 因为`$or` 实际上是执行两次查询然后将结果集合并。

### 参考网址

1. 创建普通索引 `http://pythonfans.lofter.com/post/3dd906_154c5bd`
2. 创建空间位置索引 `https://blog.csdn.net/zhangzhebjut/article/details/23021073` 

### 索引对象和数组

> MongoDB允许深入文档内部，对嵌套字段和数组建立索引。嵌套对象和数组字段可以与复合索引中的顶级字段一起使用

1. 索引嵌套文档

   ```javascript
   {
       "username" : "sid",
           "loc" : {
               "ip" : "1.2.3.4",
               "city" : "Springfield",
               "state" : "NY"
           }
       
   }
   //创建索引
   db.users.createIndex({"loc.city":1});
   ```

   >注意，对嵌套文档本身（“loc”）建立索引，与对嵌套文档的某个字段（“loc.city”）建立索引是不同的。对于整个子文档建立索引，只会提高整个子文档的查询速度。只有完全匹配才能使用 “loc” 索引。

2. 索引数组

   