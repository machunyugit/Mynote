## 积硅步, 致千里

### 索引基础

1. MySQL中， 存储引擎用类似的方法是用索引，其先在索引中找到对应值，然后根据匹配的索引记录找到对应的数据行。
2. 索引可以包含一个或者多个列的值。如果索引包含多个列，那么列的顺序也十分重要，因为__MySQL只能高效使用索引的最左前缀列。__

### 索引的类型

1. __MySQL中，索引是在存储引擎层而不是服务器层实现的。__所以没有统一的索引标准。

2. B-Tree 索引 （索引方法）

   * 各种存储引擎以不同的方式使用B-Tree索引，性能也各有不同。

   * B-Tree通常意味着所有的值都是按顺序存储的，并且每一个叶子页到根的距离相同。

   * B-Tree 索引适用于全键值、键值范围或者键前缀（最左前缀）查找。

   * 因为索引树中的节点是有序的，所以除了按值查找之外，索引还可以用于查询中的`order by` 操作（按照顺序查找）。

   * 关于组合索引B-Tree索引的限制

     1. 如果不是按照索引的最左列开始查找，则无法使用索引。

     2. 不能跳过索引中的列。也就是说，B-Tree索引无法用于查找姓Smith并且在某个特定日期出生的人。

        ![20180612194159](./image/20180612194159.png)

        

        ![20180612194227](./image/20180612194227.png)

        

        ![20180612194227](./image/20180612194521.png)

        

     3. 如果查询中有某个列的范围查询，则其右边所有列都无法使用索引优化查询。

        ```mysql
        #建立last_name,firsh_name,dob 组合索引
        where last_name = 'Smith' and firsh_name like 'J%' and dob = '1976-12-23'
        ```

3. 哈希索引 （索引方法）

   * 哈希索引基于哈希表实现，只有精确匹配索引所有列的查询才有效。

   * 对于每一行数据，存储引擎都会对所有的索引列计算一个哈希码（hash code），哈希码是一个较小的值，并且不同键值的行计算出来的哈希码也不一样。哈希索引将所有的哈希码存储在索引中，同时在哈希表中保存指向每个数据行的指针。

   * 在MySQL中，只有Memory引擎显式支持哈希索引。Memory引擎是支持非唯一哈希索引的。如果多个列的哈希值相同索引就会以链表的方式存放多个记录指针到同一个哈希条目中。

   * 哈希索引也有它的限制

     1. 哈希索引只包含哈希值和行指针，而不存储字段值，所以不能使用索引中的值来避免读取行。

     2. 哈希索引数据并不是按照索引值顺序存储的，所以也就无法用排序。

     3. 哈希索引也不支持部分索引列匹配查找，因为哈希索引始终是使用索引列的全部内容来计算哈希值的。例如，在数据列（A，B）上建立哈希索引，如果查询只有数据列A则无法使用该索引。

     4. 哈希索引只支持等值比较查询，包括 =、In()、<=>。也不支持任何范围查询。

     5. 访问哈希索引的数据非常快，除非有很多哈希冲突。

     6. 如果哈希冲突很多的话，一些索引维护操作的代价也会很高。例如，如果在某个选择性很低（哈希冲突很多）的列上建立哈希索引，那么当从表中删除一行时，存储引擎需要遍历对应哈希值的链表中的每一行，找到并删除对应行的引用，冲突越多代价越大。

     7. InnoDB引擎有一个特殊的功能叫做 “ 自适应哈希索引  ”。当InnoDB注意到某些索引值被使用得非常频繁时，它会在内存中基于B-Tree索引之上再创建一个哈希索引。

     8. 例子

        需要存储大量的URL，并需要根据URL进行搜索查找。这时候就可以使用伪哈希索引。

        ```mysql
        select id from url where url="http://www.mysql.com" and url_crc = CRC32('http://www.mysql.com')
        ```

        这样做的性能会非常高，因为MySQL优化器会使用这个选择性很高而体积很小的基于url_crc列的索引来完成查找。

        __当使用哈希索引进行查询的时候，必须在where子句中包含常量值。这样做保证了一旦出现哈希冲突，常量值也可以起作用__

4. 空间数据索引（R_Tree）

   MyISAM表支持空间索引，可以用作地理数据存储。和B-Tree索引不同，这类索引无须前缀查询。MySQL的GIS支持并不完善，开源关系数据库系统中对GIS的解决方案做得比较好的是PostgreSQL的PostGIS。

### 索引反思

1. 索引并总是最好的工具。总的来说，只有当索引帮助存储引擎快速查找记录带来的好处大于其带来的额外工作时，索引才是有效的。对于非常小的表，大部分情况下简单的全表扫描更高效。对于中到大型的表，索引就非常有效。但对特大型的表，建立和使用索引的代价将随之增长。

### 高性能的索引策略

1. 独立的列 ： 指索引列不能是表达式的一部分，也不能是函数的参数。

   ```mysql
   #不能用到索引
   select actor_id from sakila.actor where actor_id + 1 = 5;
   ```

2. 前缀索引和索引选择性

   有时候需要索引很长的字符列，这会让索引变得大且慢。一个策略是前面提到过的模拟哈希索引，但是这样做还不够的话，就可以__只索引开始的部分字符。__

3. 多列索引

   * 当出现服务对国歌索引做相交操作时（通常有多个AND条件），通常意味着需要一个包含所有相关列的多列索引，而不是多个独立的单列索引。
   * 当服务器需要对多个索引做联合操作时（通常有多个OR条件），通常意味着需要一个包含所有相关列的多列索引，而不是的多个独立的单列索引
   * 更重要的是，优化器不会把这些计算到“查询成本”中，优化器只关心随机页面读取。这会使得查询的成本被 ” 低估 “。

名称解释： 

​	1. ORM：对象关系映射。