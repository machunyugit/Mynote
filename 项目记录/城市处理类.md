```php
<?php

namespace app\common\library;
class Address
{
  private $city = null;
  private $county = null;
  private $delimiter = '_';
  private $cacheCity = null;
  private $cacheOnlyCity = null;
  private $cacheCounty = null;
  private $name;
  private $id;
  private $pid;

  /**
   * 初始化
   * @param array $city
   * @param array $county
   * @param string $name
   * @param string $id
   * @param string $pid
   */
  public function __construct(array $city, array $county, $name = 'name', $id = 'id', $pid = 'parent_id')
  {
    $this->city = $city;
    $this->county = $county;
    $this->name = $name;
    $this->id = $id;
    $this->pid = $pid;
  }

  /**
   * 查找城市县区
   * @param string $search
   * @return array
   * @deprecated
   *    0 表示正确返回
   *    -1 地址数据错误请核对或者输入的数据太少
   *    -2 城市数据错误
   *    -3 县,区数据错误
   *    -4 有重复数据，请将城市地址添加查找
   */
  public function search($search)
  {
    $search = $this->clearSpecial($search);
    $cityId = $countyId = 0;
    if (mb_strlen($search) < 2) {
      return $this->backRes($cityId, $countyId, -1);
    }
    $city = mb_substr($search, 0, 2);
    $cityData = $this->searchCity($city);
    if ($cityData) {
      list($baseCity, $pid) = explode($this->delimiter, $cityData);
      $cityCount = mb_strlen($baseCity);
      $countyCount = mb_strlen($search);
      //过滤城市字段防止干扰下级搜索结果
      $county = $this->recursionSearch($cityCount, $baseCity, $countyCount, $search);
      //过滤替换以后 '1'
      $trimResult = ltrim($county, '1');
      if (!$trimResult) {
        return $this->backRes($pid, 0, 1);
      }
      //处理县区数据
      $countyData = $this->searchCounty($pid, $trimResult);
      if (!$countyData && $pid) {
        return $this->backRes($pid, 0, 1);
      }
      list($cityId, , $countyId) = explode($this->delimiter, $countyData);
      return $this->backRes($cityId, $countyId, 1);
      //只输入县级
    } else if ($manageOnlyCounty = $this->searchOnlyCounty($city)) {
      $filtrateRes = count($manageOnlyCounty);
      if ($filtrateRes > 1) {
        return $this->backRes($cityId, $countyId, -4);
      }
      list(, $countyId, $cityId) = explode($this->delimiter, $manageOnlyCounty[0]);
      return $this->backRes($cityId, $countyId, 1);
    }
    return $this->backRes($cityId, $countyId, -1);
  }

  /**
   * 返回结果
   * @param int $cityId
   * @param int $countyId
   * @param $code
   * @return array
   */
  private function backRes($cityId, $countyId, $code)
  {
    return [
      'city' => $cityId ? $cityId : '',
      'county' => $countyId ? $countyId : '',
      'code' => $code,
    ];
  }

  /**
   * 处理县区数据
   * @param $search
   * @return array
   */
  private function searchOnlyCounty($search)
  {
    //顺义区_446_35;
    if (is_null($this->cacheOnlyCity)) {
      $this->cacheOnlyCity = [];
      foreach ($this->county as $val) {
        $this->cacheOnlyCity[] = $val[$this->name] . $this->delimiter . $val[$this->id] . $this->delimiter . $val[$this->pid];
      }
    }
    $result = [];
    foreach ($this->cacheOnlyCity as $value) {
      $res = strstr($value, $search);
      if ($res) {
        $result[] = $res;
      }
    }
    return $result;
  }

  /**
   * 处理城市数据
   * @param $search
   * @return bool|false|string
   */
  private function searchCity($search)
  {
    //杭州市_11;
    if (is_null($this->cacheCity)) {
      $this->cacheCity = [];
      foreach ($this->city as $val) {
        $this->cacheCity[] = $val[$this->name] . $this->delimiter . $val[$this->id];
      }
    }
    foreach ($this->cacheCity as $value) {
      $result = strstr($value, $search);
      if ($result) {
        return $result;
      }
    }
    return false;
  }

  /**
   * 匹配县区
   * @param int $pid
   * @param string $search
   * @return bool|mixed
   */
  private function searchCounty($pid, $search)
  {
    //35_顺义区_446;
    $pidParentNameId = [];
    if (is_null($this->cacheCounty)) {
      $this->cacheCounty = [];
      foreach ($this->county as $val) {
        $this->cacheCounty[] = $val[$this->pid] . $this->delimiter . $val[$this->name] . $this->delimiter . $val[$this->id];
      }
    }
    //先用pid搜索
    foreach ($this->cacheCounty as $value) {
      preg_match('/^' . $pid . $this->delimiter . '/u', $value, $tmp);
      if ($tmp) {
        $pidParentNameId[] = $value;
      }
    }
    //去匹配对应的县或者区数据
    foreach ($pidParentNameId as $v) {
      list(, $baseStr,) = explode($this->delimiter, $v);
      $baseCount = mb_strlen($baseStr);
      $searchCount = mb_strlen($search);
      $baseStr = $this->clearSpecial($baseStr);
      $tmp = $this->recursionSearch($baseCount, $baseStr, $searchCount, $search);
      if ($tmp) {
        return $v;
      }
    }
    return false;
  }

  /**
   * 获取县城关键字字段
   * @param int $cityLen
   * @param string $cityStr
   * @param int $searchLen
   * @param string $searchStr
   * @param int $a
   * @return bool|string|string[]|null
   */
  private function recursionSearch($cityLen, $cityStr, $searchLen, $searchStr, $a = 0)
  {
    $str0 = mb_substr($cityStr, 0, $cityLen - $a);
    $str1 = preg_replace('/^(' . $str0 . ')/u', 1, $searchStr);
    $countStr = mb_strlen($str1);
    if ($searchLen == $countStr) {
      $a++;
      if ($a >= $cityLen) {
        return false;
      }
      $result = $this->recursionSearch($cityLen, $cityStr, $searchLen, $searchStr, $a);
    } else {
      $result = $str1;
    }
    return $result;
  }

  /**
   * 过滤特殊字符
   * @param $str
   * @return string
   */
  private function clearSpecial($str)
  {
    return preg_replace('/[`~!@#$%^&*()_+<>?:"{},.\/;[\]]/im', '', $str);
  }

  public function __destruct()
  {
    unset($this->city, $this->county, $this->cacheCity, $this->cacheOnlyCity, $this->cacheCounty);
  }
}

$arr2 = array(
  array('id' => 35, 'name' => '北京市'),
  array('id' => 49, 'name' => '太原市'),
  array('id' => 50, 'name' => '大同市'),
  array('id' => 51, 'name' => '朔州市'),
  array('id' => 61, 'name' => '呼和浩特市')
);
$arr3 = array(
  array('id' => 446, 'name' => '顺义区', 'parent_id' => 35),
  array('id' => 447, 'name' => '大兴区', 'parent_id' => 35),
  array('id' => 1357, 'name' => '城区', 'parent_id' => 50),
  array('id' => 1358, 'name' => '矿区', 'parent_id' => 50),
  array('id' => 1359, 'name' => '南郊区', 'parent_id' => 50),
  array('id' => 1179, 'name' => '和林格尔县', 'parent_id' => 61),
  array('id' => 1182, 'name' => '经济开发区', 'parent_id' => 61),
  array('id' => 2923, 'name' => '新巴尔虎右旗', 'parent_id' => 61),
);
$res = new Address($arr2, $arr3);
$result = $res->search('呼和浩特新巴尔虎右旗');
```

