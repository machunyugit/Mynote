# 这是一个根据数据库记录的城市数据，将用户端输入的城市信息给匹配处理的类

```php
<?php

class Address
{
	private $city=null;
	private $county=null;

	public function __construct(array $city,array $county)
	{
		$this -> city = $city;
		$this -> county = $county;
	}
	/**
	 * 返回 1 表示正确返回
	 * 地址数据错误请核对    -1
	 * 城市数据错误请核对    -2
	 * 县,区数据错误请核对   -3
	 * 请将城市地址添加上    -4
	 * @param  [type] $search [description]
	 * @return [type]         [description]
	 */
	public function inputStr($search)
	{
		$search = $this -> clearSpecial($search);
		//定义变量
		$cityId = '';
		$countyId = '';
		if (mb_strlen($search) < 2) {
			return $this -> backRes($cityId,$countyId,-1);
		}
		$city = mb_substr($search,0,2);
		$cityData = $this -> manageCity($city);
		//输入了城市等级
		if ($cityData) {
			//获取上级的pid
			list($baseCity,$pid) = explode('_',$cityData);
			$cityCount = mb_strlen($baseCity);
			$countyCount = mb_strlen($search);
			//过滤城市字段防止干扰下级搜索结果
			$county = $this -> recursionStr($cityCount,$baseCity,$countyCount,$search);
			//过滤替换以后 '1'
			$trimResult = ltrim($county,'1');
			if (!$trimResult) {
				return $this -> backRes($pid,0,1);
			}
			//处理县区数据
			$countyData = $this -> manageCounty($pid,$trimResult);
			if (!$countyData && $pid ) {
				return $this->backRes($pid,0,1);
			}
			list($cityId,,$countyId) = explode('_',$countyData);
		//只输入县级
		} else if($manageOnlyCounty = $this -> manageOnlyCounty($city)) {
			$filtrateRes = count($manageOnlyCounty);
			if ($filtrateRes > 1) {
				return $this -> backRes($cityId,$countyId,-4);
			}
			list(,$countyId,$cityId) = explode('_',$manageOnlyCounty[0]);
		//错误
		} else {
			return $this -> backRes($cityId,$countyId,-2);
		}
		return $this -> backRes($cityId,$countyId,1);
	}
	/**
	 * 返回结果
	 * @param  [type] $cityId   [城市id]
	 * @param  [type] $countyId [县区级id]
	 * @param  [type] $code     [状态码]
	 * @return [type]           [结果]
	 */
	private function backRes($cityId,$countyId,$code)
	{
		return array(
			'city'=> $cityId ? $cityId : '',
			'county'=> $countyId ? $countyId : '',
			'code'=> $code,
		);
	}
	/**
	 * [处理县区数据](只是输入县)
	 * @return [boolean] [输入有误]
	 * @return [string]  [返回城市结果]
	 */
	private function manageOnlyCounty($search)
	{
		//顺义区_446_35;
		$name_id_parentId = array();
		$tmp = array();
		foreach ($this -> county as $val) {
			$name_id_parentId[] = $val['name'].'_'.$val['id'].'_'.$val['parent_id'];
		}
		//选取输入的字符串, 截取开始字符串的两个字符
		foreach ($name_id_parentId as $value) {
			$result = strstr($value,$search);
			if($result) {
				$tmp[] = $result;
			}
		}
		unset($name_id_parentId);
		return $tmp;
	}
	/**
	 * [处理城市数据](输入了城市)
	 * @return [boolean] [输入有误]
	 * @return [string]  [返回城市结果]
	 */
	private function manageCity($search)
	{
		//杭州市_11;
		$name_id = array();
		foreach ($this -> city as $val) {
			$name_id[] = $val['name'].'_'.$val['id'];
		}
		//如果是城市 两个字的城市可以获取到城市, 而且是唯一的  判断是否获取的是两个字的中文
		foreach ($name_id as $value) {
			$result = strstr($value,$search);
			if($result) {
				return $result;
			}
		}
		unset($name_id);
		return false;
	}
	/**
	 * 处理县,区的数据(输入了城市)
	 * @return [array] [数组]
	 */
	private function manageCounty($pid,$search)
	{
		//35_顺义区_446;
		$parent_name_id = array();
		$pidparent_name_id = array();
		foreach ($this -> county as $val) {
			$parent_name_id[] = $val['parent_id'].'_'.$val['name'].'_'.$val['id'];
		}
		//先用pid搜索
		foreach ($parent_name_id as $value) {
			preg_match ( '/^'.$pid.'_/u', $value, $tmp0);
			if ($tmp0) {
				$pidparent_name_id[] = $value;
			}
		}
		//去匹配对应的县或者区数据
		foreach ($pidparent_name_id as $v) {
			list(,$baseStr,) = explode('_', $v);
			$baseCount = mb_strlen($baseStr);
			$searchCount = mb_strlen($search);
			$baseStr = $this -> clearSpecial($baseStr);
			$tmp1 = $this -> recursionStr($baseCount,$baseStr,$searchCount,$search);
			if ($tmp1) {
				return $v;
			}
		}
		unset($parent_name_id,$pidparent_name_id,$value,$v);
		return false;
	}
	/**
	 * 过滤特殊字符
	 * @param  [type] $str [description]
	 * @return [type]      [description]
	 */
	private function clearSpecial($str)
	{
		$result = preg_replace('/[`~!@#$%^&*()_+<>?:"{},.\/;[\]]/im','',$str);
		return $result;
	}
	/**
	 * [获取县城关键字字段]
	 * @param  [int]     $cityLen   [description]
	 * @param  [string]  $cityStr   [description]
	 * @param  [int]     $searchLen [description]
	 * @param  [string]  $searchStr [description]
	 * @param  integer   $a         [description]
	 * @return [string]             [description]
	 */
	private function recursionStr($cityLen,$cityStr,$searchLen,$searchStr,$a=0)
	{
		$str0 = mb_substr($cityStr,0,$cityLen - $a);
		$str1 = preg_replace('/^('.$str0.')/u',1,$searchStr);
		$countStr = mb_strlen($str1);
		if($searchLen == $countStr) {
			$a++ ;
			if ($a >= $cityLen) {
				$tmp = false;
				return $tmp;
			}
			$tmp = $this -> recursionStr($cityLen,$cityStr,$searchLen,$searchStr,$a);
		} else {
			$tmp = $str1;
		}
		return $tmp;
	}
	/**
	 * 销毁
	 */
	public function __destruct()
	{
		unset($city,$county);
	}
}

/*
$arr2 = array(
		array('id' =>35,'name' => '北京市'),
		array('id' =>49,'name' => '太原市'),
		array('id' =>50,'name' => '大同市'),
		array('id' =>51,'name' => '朔州市'),
		array('id' =>61,'name' => '呼和浩特市')
	);*/
/*$arr3 = array(
		array('id' => 446, 'name'=> '顺义区','parent_id' => 35),
		array('id' => 447, 'name'=>  '大兴区','parent_id' => 35),
		array('id' => 1357, 'name'=> '城区','parent_id' => 50),
		array('id' => 1358, 'name'=> '矿区','parent_id' => 50),
		array('id' => 1359, 'name'=> '南郊区','parent_id' => 50),
		array('id' => 1179, 'name'=> '和林格尔县','parent_id' => 61),
		array('id' => 1182, 'name'=> '经济开发区','parent_id' => 61),
		array('id' => 2923, 'name'=> '新巴尔虎右旗','parent_id' => 61),
	);*/
$res = new Address($arr2,$arr3);
$result = $res -> inputStr('上海宝山区');
var_dump($result);die;

```

